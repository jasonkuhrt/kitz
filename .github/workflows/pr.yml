name: pr
on:
  pull_request: {}
permissions:
  contents: read
  pull-requests: write
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  # Determine what checks to run based on conventional commit type in PR title
  # chore.docs: and ci: skip code checks (only format runs)
  check-type:
    runs-on: ubuntu-latest
    outputs:
      skip-code-checks: ${{ steps.check.outputs.skip-code-checks }}
    steps:
      - name: Check PR title for CC type
        id: check
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          # Skip code checks for ci: and chore.docs: (out-of-band docs)
          # docs(pkg): runs full checks (JSDoc is code)
          if [[ "$TITLE" =~ ^ci(\(|:) ]]; then
            echo "skip-code-checks=true" >> $GITHUB_OUTPUT
            echo "Skipping code checks (ci): $TITLE"
          elif [[ "$TITLE" =~ ^chore\.docs(\(|:) ]]; then
            echo "skip-code-checks=true" >> $GITHUB_OUTPUT
            echo "Skipping code checks (chore.docs): $TITLE"
          else
            echo "skip-code-checks=false" >> $GITHUB_OUTPUT
            echo "Running full checks for: $TITLE"
          fi

  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - run: pnpm format:check

  api-model-style:
    needs: check-type
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        if: needs.check-type.outputs.skip-code-checks != 'true'
      - uses: ./.github/actions/setup
        if: needs.check-type.outputs.skip-code-checks != 'true'
      - name: Check API model style
        if: needs.check-type.outputs.skip-code-checks != 'true'
        run: pnpm check:api-model-style
      - run: echo "Skipped for chore.docs/ci commit"
        if: needs.check-type.outputs.skip-code-checks == 'true'

  # Validate that "no-release" CC types don't have package src/ changes
  # Bypass with "<!-- cc-bypass -->" in PR body for edge cases
  validate-cc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Fetch base branch
        run: git fetch origin ${{ github.event.pull_request.base.ref }}
      - name: Validate CC type matches diff
        env:
          TITLE: ${{ github.event.pull_request.title }}
          BODY: ${{ github.event.pull_request.body }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          # Check for bypass comment
          if [[ "${BODY:-}" == *"<!-- cc-bypass -->"* ]]; then
            echo "CC validation bypassed via PR comment"
            exit 0
          fi

          # No-release types: chore, style, refactor, test, build, ci, chore.docs
          NO_RELEASE_PATTERN="^(chore|style|refactor|test|build|ci|chore\.docs)(\(|:)"

          if [[ "$TITLE" =~ $NO_RELEASE_PATTERN ]]; then
            # Check for src/ changes in packages (compare against PR base)
            SRC_CHANGES=$(git diff --name-only "origin/$BASE_REF"...HEAD | grep -E '^packages/[^/]+/src/' || true)

            if [[ -n "$SRC_CHANGES" ]]; then
              echo "::error::CC type mismatch: '$TITLE' won't trigger a release, but src/ files changed"
              echo ""
              echo "Changed files:"
              echo "$SRC_CHANGES" | sed 's/^/  /'
              echo ""
              echo "Fix: Change PR title to a release type (feat:/fix:/perf:/docs:)"
              echo ""
              echo "Bypass: If intentional (e.g., true refactor with no behavior change),"
              echo "add this HTML comment anywhere in the PR body:"
              echo ""
              echo "  <!-- cc-bypass -->"
              echo ""
              exit 1
            fi
          fi

          echo "CC type validated: $TITLE"

  # Package jobs use affected-only filtering to skip unchanged packages
  # fetch-depth: 0 is required for Turborepo's git-based filtering
  # Jobs skip actual work (but still pass) for chore.docs:/ci: PRs
  # Fallback: if affected filter returns 0 packages, run all (handles new packages)
  packages-build:
    needs: check-type
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        if: needs.check-type.outputs.skip-code-checks != 'true'
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup
        if: needs.check-type.outputs.skip-code-checks != 'true'
      - name: Build packages (affected or all)
        if: needs.check-type.outputs.skip-code-checks != 'true'
        run: |
          FILTER_ARGS=(--filter="...[origin/${{ github.event.pull_request.base.ref }}]" --filter="./packages/*")
          TASK_COUNT=$(pnpm turbo run build "${FILTER_ARGS[@]}" --dry-run 2>&1 | grep "Tasks:" | grep -oE '[0-9]+ total' | grep -oE '[0-9]+' || echo "0")
          if [[ "$TASK_COUNT" == "0" ]]; then
            echo "No affected packages found, running all packages"
            pnpm turbo run build --filter="./packages/*"
          else
            echo "Running $TASK_COUNT affected package(s)"
            pnpm turbo run build "${FILTER_ARGS[@]}"
          fi
      - run: echo "Skipped for chore.docs/ci commit"
        if: needs.check-type.outputs.skip-code-checks == 'true'

  # Turbo's dependsOn + Vercel Remote Cache handles build dependencies automatically
  packages-types:
    needs: check-type
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        if: needs.check-type.outputs.skip-code-checks != 'true'
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup
        if: needs.check-type.outputs.skip-code-checks != 'true'
      - name: Type check packages (affected or all)
        if: needs.check-type.outputs.skip-code-checks != 'true'
        run: |
          FILTER_ARGS=(--filter="...[origin/${{ github.event.pull_request.base.ref }}]" --filter="./packages/*")
          TASK_COUNT=$(pnpm turbo run check:types "${FILTER_ARGS[@]}" --dry-run 2>&1 | grep "Tasks:" | grep -oE '[0-9]+ total' | grep -oE '[0-9]+' || echo "0")
          if [[ "$TASK_COUNT" == "0" ]]; then
            echo "No affected packages found, running all packages"
            pnpm turbo run check:types --filter="./packages/*"
          else
            echo "Running $TASK_COUNT affected package(s)"
            pnpm turbo run check:types "${FILTER_ARGS[@]}"
          fi
      - run: echo "Skipped for chore.docs/ci commit"
        if: needs.check-type.outputs.skip-code-checks == 'true'

  packages-lint:
    needs: check-type
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        if: needs.check-type.outputs.skip-code-checks != 'true'
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup
        if: needs.check-type.outputs.skip-code-checks != 'true'
      - name: Lint packages (affected or all)
        if: needs.check-type.outputs.skip-code-checks != 'true'
        run: |
          FILTER_ARGS=(--filter="...[origin/${{ github.event.pull_request.base.ref }}]" --filter="./packages/*")
          TASK_COUNT=$(pnpm turbo run check:lint "${FILTER_ARGS[@]}" --dry-run 2>&1 | grep "Tasks:" | grep -oE '[0-9]+ total' | grep -oE '[0-9]+' || echo "0")
          if [[ "$TASK_COUNT" == "0" ]]; then
            echo "No affected packages found, running all packages"
            pnpm turbo run check:lint --filter="./packages/*"
          else
            echo "Running $TASK_COUNT affected package(s)"
            pnpm turbo run check:lint "${FILTER_ARGS[@]}"
          fi
      - run: echo "Skipped for chore.docs/ci commit"
        if: needs.check-type.outputs.skip-code-checks == 'true'

  publint:
    needs: check-type
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        if: needs.check-type.outputs.skip-code-checks != 'true'
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup
        if: needs.check-type.outputs.skip-code-checks != 'true'
      - name: Publint packages (affected or all)
        if: needs.check-type.outputs.skip-code-checks != 'true'
        run: |
          FILTER_ARGS=(--filter="...[origin/${{ github.event.pull_request.base.ref }}]" --filter="./packages/*")
          TASK_COUNT=$(pnpm turbo run check:package "${FILTER_ARGS[@]}" --dry-run 2>&1 | grep "Tasks:" | grep -oE '[0-9]+ total' | grep -oE '[0-9]+' || echo "0")
          if [[ "$TASK_COUNT" == "0" ]]; then
            echo "No affected packages found, running all packages"
            pnpm turbo run check:package --filter="./packages/*"
          else
            echo "Running $TASK_COUNT affected package(s)"
            pnpm turbo run check:package "${FILTER_ARGS[@]}"
          fi
      - run: echo "Skipped for chore.docs/ci commit"
        if: needs.check-type.outputs.skip-code-checks == 'true'

  packages-test:
    needs: check-type
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        if: needs.check-type.outputs.skip-code-checks != 'true'
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup
        if: needs.check-type.outputs.skip-code-checks != 'true'
      - name: Test packages (affected or all)
        if: needs.check-type.outputs.skip-code-checks != 'true'
        run: |
          FILTER_ARGS=(--filter="...[origin/${{ github.event.pull_request.base.ref }}]" --filter="./packages/*")
          TASK_COUNT=$(pnpm turbo run test "${FILTER_ARGS[@]}" --dry-run 2>&1 | grep "Tasks:" | grep -oE '[0-9]+ total' | grep -oE '[0-9]+' || echo "0")
          if [[ "$TASK_COUNT" == "0" ]]; then
            echo "No affected packages found, running all packages"
            pnpm turbo run test --filter="./packages/*"
          else
            echo "Running $TASK_COUNT affected package(s)"
            pnpm turbo run test "${FILTER_ARGS[@]}"
          fi
      - run: echo "Skipped for chore.docs/ci commit"
        if: needs.check-type.outputs.skip-code-checks == 'true'

  # Generate PR release plan and post/update a comment for reviewer visibility
  release-plan-comment:
    needs: check-type
    if: needs.check-type.outputs.skip-code-checks != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Fetch base and tags
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git fetch --tags --force
      - uses: ./.github/actions/setup
      - name: Build release package
        run: pnpm turbo run build --filter=@kitz/release
      - name: Generate PR release plan
        env:
          CLI_PARAMETER_TYPE: pr
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          node packages/release/build/cli/cli.js plan > /tmp/release-plan-output.txt
      - name: Build release plan comment body
        run: |
          node <<'NODE'
          const fs = require('node:fs')

          const marker = '<!-- kitz-release-plan -->'
          const plan = JSON.parse(fs.readFileSync('.release/plan.json', 'utf8'))
          const cliOutput = fs.readFileSync('/tmp/release-plan-output.txt', 'utf8')

          const all = [...plan.releases, ...plan.cascades]
          const tableRows = all.slice(0, 80).map((item) => {
            const kind = plan.cascades.includes(item) ? 'cascade' : 'primary'
            const name = item.package.name.moniker ?? item.package.name.name ?? String(item.package.name)
            const version = `0.0.0-pr.${item.prerelease.prNumber}.${item.prerelease.iteration}.${item.prerelease.sha}`
            return `| \`${name}\` | \`${version}\` | ${kind} | ${item.commits.length} |`
          })

          const lines = [
            marker,
            '## Release Plan',
            '',
            `Generated for PR #${plan.releases[0]?.prerelease?.prNumber ?? 'unknown'} on ${plan.timestamp}.`,
            `Primary: **${plan.releases.length}**, Cascades: **${plan.cascades.length}**, Total: **${all.length}**.`,
            '',
            '| Package | Planned Version | Kind | Commits |',
            '| --- | --- | --- | ---: |',
            ...tableRows,
          ]

          if (all.length > tableRows.length) {
            lines.push(`| _...truncated_ |  |  |  |`)
            lines.push(``)
            lines.push(`Showing first ${tableRows.length} of ${all.length} planned releases.`)
          }

          const cliLines = cliOutput.trim().split('\n')
          lines.push('')
          lines.push('<details><summary>CLI output</summary>')
          lines.push('')
          lines.push('```text')
          lines.push(...cliLines.slice(0, 240))
          if (cliLines.length > 240) {
            lines.push('...truncated...')
          }
          lines.push('```')
          lines.push('</details>')

          fs.writeFileSync('/tmp/release-plan-comment.md', lines.join('\n'))
          NODE
      - name: Upsert PR release plan comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('node:fs')
            const marker = '<!-- kitz-release-plan -->'
            const body = fs.readFileSync('/tmp/release-plan-comment.md', 'utf8')
            const { owner, repo } = context.repo
            const issue_number = context.issue.number

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            })

            const existing = comments.find((c) =>
              c.user?.type === 'Bot' &&
              typeof c.body === 'string' &&
              c.body.includes(marker),
            )

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              })
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              })
            }
